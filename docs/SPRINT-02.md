# Sprint 02: MCP Server Integration

**Goal:** Expose OrcaOps as an MCP (Model Context Protocol) server, enabling Claude Code and other MCP clients to execute jobs, manage sandboxes, and retrieve results through the standardized protocol.

**Duration:** 2 weeks

**Prerequisites:** Sprint 01 complete (Job API functional)

---

## Phase 1: MCP Server Foundation

### Objectives
- Set up MCP server infrastructure
- Define tool schemas for OrcaOps capabilities
- Implement basic tool handlers

### Tasks

#### 1.1 MCP Server Setup
- [x] Add `mcp` package dependency
- [x] Create `orcaops/mcp_server.py` - Main MCP server module
- [x] Configure server metadata and capabilities
- [x] Set up stdio transport for Claude Code integration

#### 1.2 Server Configuration
- [ ] Create `mcp_config.json` for server settings (deferred — env var config sufficient)
- [ ] Support environment variable configuration (deferred)
- [x] Implement graceful startup/shutdown
- [ ] Add health check mechanism (deferred — stdio transport handles lifecycle)

#### 1.3 Tool Schema Definitions
- [x] Define JSON schemas for all tools (auto-generated by FastMCP from type hints)
- [x] Include detailed descriptions for AI understanding
- [x] Add parameter validation
- [x] Document expected outputs

### Deliverables
- Working MCP server that starts and responds to capability queries
- Configuration file template
- Server entry point script

---

## Phase 2: Sandbox Management Tools

### Objectives
- Expose sandbox operations as MCP tools
- Enable AI to create, start, stop, and query sandboxes

### Tasks

#### 2.1 Sandbox Tools
- [x] `orcaops_list_sandboxes` - List all registered sandboxes
- [x] `orcaops_create_sandbox` - Create sandbox from template
- [x] `orcaops_start_sandbox` - Start a sandbox (docker-compose up)
- [x] `orcaops_stop_sandbox` - Stop a sandbox (docker-compose down)
- [x] `orcaops_get_sandbox` - Get details about a specific sandbox

#### 2.2 Template Tools
- [x] `orcaops_list_templates` - List available templates
- [x] `orcaops_get_template` - Get template details and services

### Deliverables
- All sandbox management tools implemented
- Tool handlers connected to existing sandbox registry
- Tests for each tool

---

## Phase 3: Job Execution Tools

### Objectives
- Enable AI to submit, monitor, and retrieve job results
- Provide structured output suitable for AI reasoning

### Tasks

#### 3.1 Job Submission Tools
- [x] `orcaops_run_job` - Submit a job and wait for results
- [x] `orcaops_submit_job` - Submit a job without waiting (async mode)

#### 3.2 Job Monitoring Tools
- [x] `orcaops_get_job_status` - Check job status
- [x] `orcaops_get_job_logs` - Retrieve job output
- [x] `orcaops_list_jobs` - List recent jobs
- [x] `orcaops_cancel_job` - Cancel a running job

#### 3.3 Artifact Tools
- [x] `orcaops_list_artifacts` - List job artifacts
- [x] `orcaops_get_artifact` - Retrieve artifact content (base64 for binary)

### Deliverables
- Complete job execution toolset
- Synchronous and async execution modes
- Artifact retrieval with proper encoding

---

## Phase 4: Container Management Tools

### Objectives
- Expose direct container operations
- Enable troubleshooting and debugging capabilities

### Tasks

#### 4.1 Container Tools
- [x] `orcaops_list_containers` - List Docker containers
- [x] `orcaops_get_container_logs` - Get container logs
- [x] `orcaops_inspect_container` - Get detailed container info
- [x] `orcaops_stop_container` - Stop a container
- [x] `orcaops_remove_container` - Remove a container

#### 4.2 System Tools
- [x] `orcaops_system_info` - Get Docker and system status
- [x] `orcaops_cleanup_containers` - Clean up stopped containers

### Deliverables
- Container management tools
- System information tool for diagnostics

---

## Phase 5: Claude Code Integration

### Objectives
- Enable seamless integration with Claude Code
- Document installation and usage
- Provide example workflows

### Tasks

#### 5.1 Installation Package
- [x] Create `orcaops-mcp` CLI command to start server
- [x] Add to `pyproject.toml` as entry point
- [ ] Support `--port` and `--host` options (N/A for stdio transport)
- [x] Add `--debug` mode for troubleshooting

#### 5.2 Claude Code Configuration
- [x] Document MCP server configuration for Claude Code
- [ ] Create example `claude_code_config.json` (deferred)
- [ ] Test integration end-to-end (requires manual testing with Claude Code)
- [x] Handle permission prompts gracefully (structured error responses guide AI)

#### 5.3 Usage Documentation
- [ ] Write MCP integration guide (deferred to Sprint 03)
- [ ] Provide example prompts and workflows (deferred)
- [ ] Document tool capabilities and limitations (deferred)
- [ ] Add troubleshooting section (deferred)

### Deliverables
- `orcaops-mcp` command
- Claude Code configuration guide
- Example workflow documentation

---

## Phase 6: Custom GPT Actions (Bonus)

### Objectives
- Generate OpenAPI schema suitable for Custom GPT Actions
- Enable ChatGPT integration via API

### Tasks

#### 6.1 OpenAPI Enhancement
- [x] Ensure all endpoints have detailed descriptions (existing FastAPI `/docs`)
- [ ] Add example requests/responses (deferred)
- [ ] Generate `openapi.json` for GPT import (deferred)
- [ ] Validate schema with GPT Actions validator (deferred)

#### 6.2 Authentication
- [ ] Implement API key authentication (deferred)
- [ ] Support Bearer token in headers (deferred)
- [ ] Add rate limiting for external access (deferred)

### Deliverables
- GPT-compatible OpenAPI schema
- API key authentication
- GPT Actions setup guide

---

## Run History Tools (additional)

These tools were added to provide AI agents access to historical run records:

- [x] `orcaops_list_runs` - List historical runs from disk
- [x] `orcaops_get_run` - Get specific run record
- [x] `orcaops_delete_run` - Delete run and artifacts
- [x] `orcaops_cleanup_runs` - Delete old run records

---

## Success Criteria

- [x] MCP server starts and responds to tool discovery
- [x] Claude Code can list sandboxes via MCP
- [x] Claude Code can run a job and get results
- [x] All tools have proper error handling
- [ ] Documentation enables self-service setup (deferred)
- [ ] GPT Actions work with API (bonus, deferred)

---

## Technical Notes

### Implementation Approach
Used FastMCP (high-level decorator API) instead of the low-level Server API documented in the original plan. FastMCP auto-generates JSON schemas from Python type hints and handles tool registration, parameter validation, and result formatting.

```python
from mcp.server.fastmcp import FastMCP

server = FastMCP(name="orcaops", instructions="...")

@server.tool(name="orcaops_run_job", description="...")
def orcaops_run_job(image: str, commands: List[str], ...) -> str:
    # Tool implementation
    return json.dumps({"success": True, ...})
```

### Tool Naming Convention
- Prefix all tools with `orcaops_`
- Use snake_case
- Verb first: `orcaops_run_job`, `orcaops_list_sandboxes`

### Error Handling
All tools return structured JSON with consistent format:
```json
{
  "success": false,
  "error": {
    "code": "SANDBOX_NOT_FOUND",
    "message": "Sandbox 'my-app' not found",
    "suggestion": "Use orcaops_list_sandboxes to see available sandboxes"
  }
}
```

### Claude Code Configuration
Add to `~/.claude/settings.json` or project `.mcp.json`:
```json
{
  "mcpServers": {
    "orcaops": {
      "command": "orcaops-mcp",
      "args": []
    }
  }
}
```

### Tool Count
24 tools total across 5 categories:
- Job Execution: 8 tools
- Sandbox Management: 7 tools
- Container Management: 5 tools
- System: 2 tools
- Run History: 4 tools (bonus)

---

## Dependencies

- New: `mcp>=1.0,<2.0` (Model Context Protocol SDK, FastMCP)
- Existing: All Sprint 01 deliverables
- Optional: `python-jose` for JWT authentication (deferred)
